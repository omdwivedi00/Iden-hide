<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>js-file-download Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input[type="file"] { margin: 10px 0; }
        #results { margin-top: 20px; }
        .result-item { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; }
        .test-case { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 3px; }
    </style>
    <script src="https://unpkg.com/js-file-download@0.4.12/dist/js-file-download.min.js"></script>
</head>
<body>
    <h1>üì¶ js-file-download Test</h1>
    
    <div class="test-section">
        <h3>1. Test js-file-download Library</h3>
        <div>
            <button onclick="testTextDownload()">Test Text Download</button>
            <button onclick="testBlobDownload()">Test Blob Download</button>
            <button onclick="testImageDownload()">Test Image Download</button>
        </div>
    </div>

    <div class="test-section">
        <h3>2. Test with Real API</h3>
        <div>
            <button onclick="testApiDownload()">Test API Download</button>
            <button onclick="testInvalidApiDownload()">Test Invalid API Download</button>
        </div>
    </div>

    <div class="test-section">
        <h3>3. Test Error Handling</h3>
        <div>
            <button onclick="testNullDownload()">Test Null Download</button>
            <button onclick="testEmptyDownload()">Test Empty Download</button>
        </div>
    </div>

    <div class="test-section">
        <h3>4. Results</h3>
        <div id="results"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result-item ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('results').appendChild(div);
        }

        function testTextDownload() {
            try {
                log('Testing text download with js-file-download...', 'info');
                
                const textData = 'Hello, World!\nThis is a test file.\nDownloaded using js-file-download library.';
                const filename = 'test_file.txt';
                
                // Use js-file-download
                fileDownload(textData, filename);
                
                log('‚úÖ Text download initiated successfully', 'success');
            } catch (error) {
                log(`‚ùå Text download failed: ${error.message}`, 'error');
            }
        }

        function testBlobDownload() {
            try {
                log('Testing blob download with js-file-download...', 'info');
                
                const textData = 'This is blob data for testing.';
                const blob = new Blob([textData], { type: 'text/plain' });
                const filename = 'test_blob.txt';
                
                // Use js-file-download with blob
                fileDownload(blob, filename);
                
                log('‚úÖ Blob download initiated successfully', 'success');
            } catch (error) {
                log(`‚ùå Blob download failed: ${error.message}`, 'error');
            }
        }

        function testImageDownload() {
            try {
                log('Testing image download with js-file-download...', 'info');
                
                // Create a simple canvas image
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                
                // Draw something on canvas
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(0, 0, 200, 100);
                ctx.fillStyle = 'white';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Test Image', 100, 50);
                
                // Convert to blob
                canvas.toBlob((blob) => {
                    if (blob) {
                        fileDownload(blob, 'test_image.png');
                        log('‚úÖ Image download initiated successfully', 'success');
                    } else {
                        log('‚ùå Failed to create image blob', 'error');
                    }
                }, 'image/png');
                
            } catch (error) {
                log(`‚ùå Image download failed: ${error.message}`, 'error');
            }
        }

        async function testApiDownload() {
            try {
                log('Testing API download with js-file-download...', 'info');
                
                const filename = 'frame_000000_1757766019_blurred.jpg';
                const response = await fetch(`${API_BASE_URL}/download/${filename}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                
                if (blob.size === 0) {
                    throw new Error('Received empty file');
                }
                
                log(`Downloaded ${blob.size} bytes from API`, 'info');
                
                // Use js-file-download
                fileDownload(blob, `downloaded_${filename}`);
                
                log('‚úÖ API download initiated successfully', 'success');
                
            } catch (error) {
                log(`‚ùå API download failed: ${error.message}`, 'error');
            }
        }

        async function testInvalidApiDownload() {
            try {
                log('Testing invalid API download...', 'info');
                
                const filename = 'nonexistent_file.jpg';
                const response = await fetch(`${API_BASE_URL}/download/${filename}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    log(`‚úÖ Invalid download handled correctly: ${errorData.detail}`, 'success');
                    return;
                }
                
                log('‚ùå Invalid download should have failed', 'error');
                
            } catch (error) {
                log(`‚úÖ Invalid download error handled: ${error.message}`, 'success');
            }
        }

        function testNullDownload() {
            try {
                log('Testing null download...', 'info');
                
                // This should cause an error
                fileDownload(null, 'test.txt');
                
                log('‚ùå Null download should have failed', 'error');
            } catch (error) {
                log(`‚úÖ Null download handled correctly: ${error.message}`, 'success');
            }
        }

        function testEmptyDownload() {
            try {
                log('Testing empty download...', 'info');
                
                const emptyBlob = new Blob([], { type: 'text/plain' });
                fileDownload(emptyBlob, 'empty.txt');
                
                log('‚úÖ Empty download handled (js-file-download allows empty files)', 'success');
            } catch (error) {
                log(`‚ùå Empty download failed: ${error.message}`, 'error');
            }
        }

        // Test on page load
        window.onload = function() {
            log('Page loaded. Testing js-file-download library integration.', 'info');
            
            // Check if library is loaded
            if (typeof fileDownload === 'function') {
                log('‚úÖ js-file-download library loaded successfully', 'success');
            } else {
                log('‚ùå js-file-download library not loaded', 'error');
            }
        };
    </script>
</body>
</html>
